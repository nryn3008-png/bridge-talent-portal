generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Jobs ────────────────────────────────────────────────────────────────────
// Matches architecture.md §2.1 jobs table exactly
model Job {
  id              String    @id @default(uuid())
  companyDomain   String    @map("company_domain")
  postedBy        String    @map("posted_by")
  bridgeAskId     String?   @map("bridge_ask_id")
  title           String
  description     String    @db.Text
  requirements    String?   @db.Text
  department      String?
  employmentType  String?   @map("employment_type") // full_time, part_time, contract, internship
  experienceLevel String?   @map("experience_level") // entry, mid, senior, lead, executive
  salaryMin       Int?      @map("salary_min")
  salaryMax       Int?      @map("salary_max")
  salaryCurrency  String    @default("USD") @map("salary_currency")
  showSalary      Boolean   @default(true) @map("show_salary")
  location        String?
  workType        String?   @map("work_type") // remote, hybrid, onsite
  skillsRequired  String[]  @map("skills_required")
  externalId      String?   @unique @map("external_id") // ATS-specific ID (e.g., workable:SHORTCODE)
  source          String    @default("manual") // manual | workable
  status          String    @default("active") // active, paused, closed, filled
  visibility      String    @default("network") // network, portfolio_only, public
  applyUrl        String?   @map("apply_url")
  expiresAt       DateTime? @map("expires_at")
  viewCount       Int       @default(0) @map("view_count")
  applyCount      Int       @default(0) @map("apply_count")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  applications Application[]

  @@index([status], map: "idx_jobs_status")
  @@index([companyDomain], map: "idx_jobs_company")
  @@map("jobs")
}

// ─── Applications ────────────────────────────────────────────────────────────
model Application {
  id               String    @id @default(uuid())
  jobId            String    @map("job_id")
  bridgeUserId     String    @map("bridge_user_id")
  status           String    @default("applied") // applied, reviewed, interviewing, offered, hired, rejected, withdrawn
  coverNote        String?   @map("cover_note") @db.Text
  resumeUrl        String?   @map("resume_url")
  screeningAnswers Json      @default("{}") @map("screening_answers")
  referredBy       String?   @map("referred_by")
  introId          String?   @map("intro_id")
  matchScore       Float?    @map("match_score")
  matchBreakdown   Json?     @map("match_breakdown")
  reviewedAt       DateTime? @map("reviewed_at")
  respondedAt      DateTime? @map("responded_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  job Job @relation(fields: [jobId], references: [id])

  @@unique([jobId, bridgeUserId])
  @@index([jobId], map: "idx_applications_job")
  @@index([bridgeUserId], map: "idx_applications_user")
  @@index([status], map: "idx_applications_status")
  @@map("applications")
}

// ─── Events ──────────────────────────────────────────────────────────────────
model Event {
  id            String   @id @default(uuid())
  title         String
  description   String?  @db.Text
  eventType     String?  @map("event_type") // hiring_fair, office_hours, fireside_chat, networking
  hostedBy      String   @map("hosted_by")
  networkDomain String?  @map("network_domain")
  location      String?
  isVirtual     Boolean  @default(true) @map("is_virtual")
  virtualLink   String?  @map("virtual_link")
  startsAt      DateTime @map("starts_at")
  endsAt        DateTime @map("ends_at")
  maxAttendees  Int?     @map("max_attendees")
  createdAt     DateTime @default(now()) @map("created_at")

  rsvps EventRsvp[]

  @@map("events")
}

model EventRsvp {
  id           String   @id @default(uuid())
  eventId      String   @map("event_id")
  bridgeUserId String   @map("bridge_user_id")
  status       String   @default("going") // going, maybe, not_going
  createdAt    DateTime @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id])

  @@unique([eventId, bridgeUserId])
  @@map("event_rsvps")
}

// ─── Bridge Sync Log ──────────────────────────────────────────────────────────
model BridgeSyncLog {
  id            String   @id @default(uuid())
  syncType      String   @map("sync_type")   // bulk, delta, webhook
  entityType    String   @map("entity_type") // users, profiles, intros, asks
  lastSyncedAt  DateTime @map("last_synced_at")
  recordsSynced Int      @default(0) @map("records_synced")
  status        String   @default("completed") // running, completed, failed
  errorMessage  String?  @map("error_message") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("bridge_sync_log")
}

// ─── Portfolio ATS Cache ─────────────────────────────────────────────────────
// Caches which ATS provider each portfolio company uses, so scheduled syncs
// can fetch jobs directly without re-probing all 4 providers every time.
model PortfolioAtsCache {
  id            String    @id @default(uuid())
  companyDomain String    @unique @map("company_domain")
  provider      String    // workable, greenhouse, lever, ashby
  slug          String    // the ATS board slug that worked
  lastSyncedAt  DateTime? @map("last_synced_at")
  jobCount      Int       @default(0) @map("job_count")
  lastCheckedAt DateTime  @default(now()) @map("last_checked_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("portfolio_ats_cache")
}

// ─── Saved Jobs ───────────────────────────────────────────────────────────────
model SavedJob {
  id           String   @id @default(uuid())
  bridgeUserId String   @map("bridge_user_id")
  jobId        String   @map("job_id")
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([bridgeUserId, jobId])
  @@map("saved_jobs")
}

// ─── VC Networks ──────────────────────────────────────────────────────────────
// Caches VC network details from Bridge API GET /api/v1/tags/:domain/details
// so portfolio + jobs pages don't need to call Bridge API on every page load.
model VcNetwork {
  id                 String    @id @default(uuid())
  domain             String    @unique
  title              String?
  description        String?   @db.Text
  location           String?
  isVc               Boolean   @default(true) @map("is_vc")
  founders           String[]
  industries         String[]
  industriesInvestIn Json      @default("{}") @map("industries_invest_in")
  investmentFocus    String?   @map("investment_focus")
  lastSyncedAt       DateTime? @map("last_synced_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  portfolioCompanies PortfolioCompany[]

  @@map("vc_networks")
}

// ─── Portfolio Companies ─────────────────────────────────────────────────────
// Caches portfolio company data from Bridge API v4 network_portfolios endpoint
// so portfolio pages load from local DB instead of paginating through Bridge API.
model PortfolioCompany {
  id           String    @id @default(uuid())
  domain       String
  vcDomain     String    @map("vc_domain")
  description  String?   @db.Text
  industries   String[]
  status       String?
  funded       Int?
  investDate   String?   @map("invest_date")
  lastSyncedAt DateTime? @map("last_synced_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  vcNetwork VcNetwork @relation(fields: [vcDomain], references: [domain])

  @@unique([domain, vcDomain])
  @@index([vcDomain], map: "idx_portfolio_companies_vc")
  @@map("portfolio_companies")
}
